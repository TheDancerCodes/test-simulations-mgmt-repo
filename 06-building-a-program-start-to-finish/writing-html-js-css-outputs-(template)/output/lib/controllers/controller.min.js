"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};iDexApp.controller("iicontroller",["$scope","$localStorage","toastr","Utility",function(e,o,n,t){var r=new InvertedIndex;e.bookTitles=[],e.iiScopeHolder={},e.numberOfDocuments=r.numberOfDocuments,e.books=r.unIndexedBooks,e.showIndexes=!1,e.showSearches=!1,e.toggleSort=function(){e.showIndexes=!1,e.iiScopeHolder=t.toggleSort(e.iiScopeHolder),e.showIndexes=!0,t.toggleSortInnerText("toggele-sortB","toggele-sort")},e.doUpload=function(o,a,s){for(var d=0;d<a;d+=1){var i=function(a){var d=o[a].name.split(".")[0].toLowerCase();return"json"!==o[a].name.split(".").pop()?(s.value="",{v:t.feedback("Invalid file type. Only a .JSON file is allowed")}):e.bookTitles.includes(d)?{v:n.warning("File has already been uploaded","Already uploaded")}:void e.readFile(o[a]).then(function(t){Object.keys(t).map(function(s){r.unIndexedBooks[s]=t[s],o[a]&&(e.$apply(function(){e.bookTitles.push(d)}),n.success(s+" upload is successful"),document.getElementById("create-index").innerText="Ready to create an iDex")})}).catch(function(e){return s.value="",t.feedback(e)})}(d);if("object"===(void 0===i?"undefined":_typeof(i)))return i.v}},e.readFile=function(e){return new Promise(function(o,n){if(window.FileReader){var t=new FileReader;t.onload=function(){return function(t){try{var a=e.name,s=r.readFile(t.target.result);r.validateFile(s,a).then(function(e){return o(e)}).catch(function(e){return n("This is not a valid json file\n Please get one with a vaild title and text properties")})}catch(o){n(e.name+' is not a valid .json file.\n          Use a .json file with a "title" and "text" properties\n          Upload cancelled')}}}(),t.readAsText(e)}else n("The FileReader API is not supported in this browser. \nUpdate your browser")})},e.buildIndex=function(){if(void 0===e.selectedBook)return t.feedback("Please select a book to index");e.showIndexes=!0,e.showSearches=!1;var o=e.selectedBook;if("allBooks"===o)t.feedback("Unsupported.\n You can't create index for multiple files at the moment."),n.warning("That feature is not yet implemented.","Unsupported"),e.showIndexes=!1;else if(Object.keys(r.iDexMapper).indexOf(o)>-1)e.iiScopeHolder=r.getIndex(o),e.numberOfDocuments[o]=r.numberOfDocuments[o],t.toggleSortInnerText("toggele-sort","toggele-sortB");else{var a=e.books[o];e.numberOfDocuments[o]=[],r.createIndex(o,a).then(function(e){return e}),e.iiScopeHolder=r.getIndex(o),e.numberOfDocuments[o]=r.numberOfDocuments[o],t.newlyCreatedIndexInnerText()}},e.doSearch=function(){if(!e.bookToSearch)return r.feedback("Select an indexed book before search");var o=e.searchToken,n=r.tokenize(o),t=e.bookToSearch;e.showSearches=!0,e.showIndexes=!1,e.searchResult=r.searchIndex(t,n)},e.clickSearch=function(){if(!e.searchToken)return t.feedback("A word must be entered to search");e.doSearch()},e.doLiveSearch=function(){e.searchToken.length>3&&e.liveSearch===!0?e.doSearch():e.searchResult=[]},e.createIndexButtonText=function(){var o=e.selectedBook;Object.keys(r.iDexMapper).indexOf(o)!==-1?document.getElementById("create-index").innerText="Already indexed":(document.getElementById("create-index").innerText="Get indexes",e.showIndexes=!1),e.iiScopeHolder=r.getIndex(o)},e.searchIndexButtonText=function(){e.showIndexes=!1;var o=e.bookToSearch;document.getElementById("search-idex").innerText="Search "+o},e.saveAllData=function(){if(Object.keys(r.iDexMapper).length<1)return t.feedback("Please index a book before trying to save"),void n.error("Please index a book before trying to save","Error");o.savedBooks={},o.numberOfDocuments={},o.savedBooks=r.iDexMapper,o.numberOfDocuments=r.numberOfDocuments,n.success("All data have been saved to local storage.","Success")},e.loadAllData=function(){!o.savedBooks||Object.keys(o.savedBooks).length<1?n.error("Sorry bro, no data has been saved.","Error"):Object.keys(r.iDexMapper).length>0?n.warning("All data have been loaded to workspace.","Warning"):(r.iDexMapper=o.savedBooks,r.numberOfDocuments=o.numberOfDocuments,e.numberOfDocuments=r.numberOfDocuments,e.books=r.iDexMapper,Object.keys(r.iDexMapper).map(function(o){e.bookTitles.push(o)}),n.success("All data have been loaded to workspace.","Success"))},e.deleteAllData=function(){!o.savedBooks||Object.keys(o.savedBooks).length<1?n.error("Sorry bro, no data has been saved.","Error"):(o.savedBooks={},r.iDexMapper={},o.numberOfDocuments={},r.numberOfDocuments={},e.books={},n.warning("All data have been deleted from local storage.","Warning"))}}]),document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("book-uploader");e.addEventListener("change",function(){var o=e.files,n=o.length;angular.element(document.getElementById("book-uploader")).scope().doUpload(o,n,e)},!1)});